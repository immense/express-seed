<!DOCTYPE html><html lang="en"><head><title>app/lib/node-pbkdf2</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../"><meta name="groc-document-path" content="app/lib/node-pbkdf2"><meta name="groc-project-path" content="app/lib/node-pbkdf2.coffee"><link rel="stylesheet" type="text/css" media="all" href="../../assets/style.css"><script type="text/javascript" src="../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/lib/node-pbkdf2.coffee</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="nv">crypto = </span><span class="nx">require</span> <span class="s">&#39;crypto&#39;</span>

<span class="k">class</span> <span class="nx">NodePbkdf2</span>

  <span class="nv">constructor: </span><span class="nf">(options = {}) -&gt;</span>
    <span class="vi">@iterations       = </span><span class="nx">options</span><span class="p">.</span><span class="nx">iterations</span>       <span class="o">or</span> <span class="mi">10000</span>
    <span class="vi">@saltLength       = </span><span class="nx">options</span><span class="p">.</span><span class="nx">saltLength</span>       <span class="o">or</span> <span class="mi">12</span>
    <span class="vi">@derivedKeyLength = </span><span class="nx">options</span><span class="p">.</span><span class="nx">derivedKeyLength</span> <span class="o">or</span> <span class="mi">30</span>
    <span class="vi">@lengthLimit      = </span><span class="nx">options</span><span class="p">.</span><span class="nx">lengthLimit</span>      <span class="o">or</span> <span class="mi">4096</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>private functions</p></div></div><div class="code"><div class="wrapper">  <span class="nv">uid = </span><span class="nf">(len) -&gt;</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">randomBytes</span><span class="p">(</span><span class="nx">len</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s">&#39;base64&#39;</span><span class="p">).</span><span class="nx">slice</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">len</span>

  <span class="nv">serializePasswordData = </span><span class="nf">(passwordData) -&gt;</span>
    <span class="p">[</span><span class="nx">passwordData</span><span class="p">.</span><span class="nx">salt</span><span class="p">,</span> <span class="nx">passwordData</span><span class="p">.</span><span class="nx">derivedKey</span><span class="p">,</span> <span class="nx">passwordData</span><span class="p">.</span><span class="nx">derivedKeyLength</span><span class="p">,</span> <span class="nx">passwordData</span><span class="p">.</span><span class="nx">iterations</span><span class="p">].</span><span class="nx">join</span> <span class="s">&#39;::&#39;</span>


  <span class="nv">deserializePasswordData = </span><span class="nf">(serializedPasswordData) -&gt;</span>
    <span class="p">[</span><span class="nx">salt</span><span class="p">,</span> <span class="nx">derivedKey</span><span class="p">,</span> <span class="nx">derivedKeyLength</span><span class="p">,</span> <span class="nx">iterations</span><span class="p">]</span> <span class="o">=</span> <span class="nx">serializedPasswordData</span><span class="p">.</span><span class="nx">split</span> <span class="s">&#39;::&#39;</span>

    <span class="nv">salt: </span><span class="nx">salt</span>
    <span class="nv">derivedKey: </span><span class="nx">derivedKey</span>
    <span class="nv">derivedKeyLength: </span><span class="nb">parseInt</span> <span class="nx">derivedKeyLength</span><span class="p">,</span> <span class="mi">10</span>
    <span class="nv">iterations: </span><span class="nb">parseInt</span> <span class="nx">iterations</span><span class="p">,</span> <span class="mi">10</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>public functions</p></div></div><div class="code"><div class="wrapper">  <span class="nv">hashPassword: </span><span class="nf">(plaintextPassword, cb) -&gt;</span>
    <span class="k">if</span> <span class="nx">plaintextPassword</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">@lengthLimit</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;password is too long&#39;</span>
    <span class="nv">randomSalt = </span><span class="nx">uid</span> <span class="nx">@saltLength</span>
    <span class="nx">crypto</span><span class="p">.</span><span class="nx">pbkdf2</span> <span class="nx">plaintextPassword</span><span class="p">,</span> <span class="nx">randomSalt</span><span class="p">,</span> <span class="nx">@iterations</span><span class="p">,</span> <span class="nx">@derivedKeyLength</span><span class="p">,</span> <span class="nf">(err, derivedKey) =&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span>

      <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">serializePasswordData</span>
        <span class="nv">salt: </span><span class="nx">randomSalt</span>
        <span class="nv">iterations: </span><span class="nx">@iterations</span>
        <span class="nv">derivedKeyLength: </span><span class="nx">@derivedKeyLength</span>
        <span class="nv">derivedKey: </span><span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">derivedKey</span><span class="p">,</span> <span class="s">&#39;binary&#39;</span><span class="p">).</span><span class="nx">toString</span> <span class="s">&#39;base64&#39;</span>

  <span class="nv">checkPassword: </span><span class="nf">(plaintextPassword, serializedPasswordData, cb) -&gt;</span>
    <span class="k">if</span> <span class="nx">plaintextPassword</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="nx">@lengthLimit</span> <span class="k">then</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&#39;password is too long&#39;</span>
    <span class="p">{</span><span class="nx">salt</span><span class="p">,</span> <span class="nx">derivedKey</span><span class="p">,</span> <span class="nx">derivedKeyLength</span><span class="p">,</span> <span class="nx">iterations</span><span class="p">}</span> <span class="o">=</span> <span class="nx">deserializePasswordData</span> <span class="nx">serializedPasswordData</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">salt</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">derivedKey</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">iterations</span><span class="o">?</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">derivedKeyLength</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">cb</span> <span class="s">&#39;serializedPasswordData doesn\&#39;t have the right format&#39;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Use the encrypted password's parameter to hash the candidate password</p></div></div><div class="code"><div class="wrapper">    <span class="nx">crypto</span><span class="p">.</span><span class="nx">pbkdf2</span> <span class="nx">plaintextPassword</span><span class="p">,</span> <span class="nx">salt</span><span class="p">,</span> <span class="nx">iterations</span><span class="p">,</span> <span class="nx">derivedKeyLength</span><span class="p">,</span> <span class="nf">(err, candidateDerivedKey) -&gt;</span>
      <span class="k">if</span> <span class="nx">err</span><span class="o">?</span> <span class="k">then</span> <span class="k">return</span> <span class="nx">cb</span> <span class="nx">err</span>
      <span class="k">if</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">candidateDerivedKey</span><span class="p">,</span> <span class="s">&#39;binary&#39;</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="s">&#39;base64&#39;</span><span class="p">)</span> <span class="o">is</span> <span class="nx">derivedKey</span>
        <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">true</span>
      <span class="k">else</span>
        <span class="nx">cb</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">false</span>

<span class="nv">module.exports = </span><span class="nx">NodePbkdf2</span></div></div></div></div></body></html>